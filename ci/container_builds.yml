include:
  - remote: "https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/80f87b3058efb75a1faae11826211375fba77e7f/templates/opensuse.yml"

variables:
  # When branching change the suffix to avoid conflicts with images
  # from the main branch
  BASE_TAG: "2023-09-19.0-main"
  RUST_STABLE: "1.72.0"
  RUST_MINIMUM: "1.70.0"
  RUSTUP_VERSION: "1.26.0"

.container.opensuse@common:
  stage: "container-build"
  before_script:
    - source ./ci/env.sh
  variables:
    FDO_DISTRIBUTION_VERSION: "tumbleweed"
    FDO_UPSTREAM_REPO: "gnome/librsvg"
    FDO_DISTRIBUTION_PACKAGES: >-
      autoconf
      automake
      cairo-devel
      clang
      clang-tools
      curl
      diffutils
      findutils
      gawk
      gcc
      gdb
      gdk-pixbuf-devel
      gettext
      gettext-tools
      git
      gobject-introspection-devel
      google-roboto-fonts
      itstool
      libtool
      libxml2-devel
      make
      openssl-devel
      pango-devel
      python3-pip
      shadow
      system-group-wheel
      vala
      wget
      xz

.container.opensuse@x86_64.stable:
  extends: .container.opensuse@common
  variables:
    FDO_DISTRIBUTION_TAG: "x86_64-${RUST_STABLE}-${BASE_TAG}"
    FDO_DISTRIBUTION_EXEC: >-
      bash ci/install-python-tools.sh &&
      bash ci/install-rust.sh --rustup-version ${RUSTUP_VERSION} \
                              --stable ${RUST_STABLE} \
                              --arch x86_64-unknown-linux-gnu &&
      bash ci/install-rust-tools.sh &&
      bash ci/install-grcov.sh &&
      rm -rf /root/.cargo /root/.cache    # cleanup compilation dirs; binaries are installed now

.container.opensuse@x86_64.minimum:
  extends: .container.opensuse@common
  variables:
    FDO_DISTRIBUTION_TAG: "x86_64-${RUST_MINIMUM}-${BASE_TAG}"
    FDO_DISTRIBUTION_EXEC: >-
      bash ci/install-rust.sh --rustup-version ${RUSTUP_VERSION} \
                              --stable ${RUST_MINIMUM} \
                              --arch x86_64-unknown-linux-gnu

.container.opensuse@x86_64.nightly:
  extends: .container.opensuse@common
  variables:
    FDO_DISTRIBUTION_TAG: "x86_64-nightly-${BASE_TAG}"
    FDO_DISTRIBUTION_EXEC: >-
      bash ci/install-rust.sh --rustup-version ${RUSTUP_VERSION} \
                              --stable nightly \
                              --arch x86_64-unknown-linux-gnu

.container.opensuse@aarch64:
  extends: .container.opensuse@common
  variables:
    FDO_DISTRIBUTION_TAG: "aarch64-${RUST_STABLE}-${BASE_TAG}"
    FDO_DISTRIBUTION_EXEC: >-
      bash ci/install-rust.sh --rustup-version ${RUSTUP_VERSION} \
                              --stable ${RUST_STABLE} \
                              --arch aarch64-unknown-linux-gnu
  tags:
    - aarch64

opensuse-container@x86_64.stable:
  extends:
    - .fdo.container-build@opensuse@x86_64
    - .container.opensuse@x86_64.stable
  stage: "container-build"

opensuse-container@x86_64.minimum:
  extends:
    - .fdo.container-build@opensuse@x86_64
    - .container.opensuse@x86_64.minimum
  stage: "container-build"

opensuse-container@x86_64.nightly:
  extends:
    - .fdo.container-build@opensuse@x86_64
    - .container.opensuse@x86_64.nightly
  stage: "container-build"

opensuse-container@aarch64:
  extends:
    - .fdo.container-build@opensuse@aarch64
    - .container.opensuse@aarch64
  stage: "container-build"
